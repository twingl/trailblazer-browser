(function(){var e;e=SimpleAuth.Authenticators.Base.extend({restore:function(){},authenticate:function(){return new Ember.RSVP.Promise(function(e,t){var n,i,r,o;return n=""+window.ENV.api_host+"/oauth/authorize",r=encodeURIComponent("https://"+chrome.runtime.id+".chromiumapp.org/"),i="f2c3d77a1a31f9149d92c9c02a030787e4c4d3531727f5b6732e379454d246ed",o=""+n+"?client_id="+i+"&response_type=token&redirect_uri="+r,chrome.identity.launchWebAuthFlow({url:o,interactive:!0},function(n){var i,r,o,a,c,u,s;for(o=n.substring(n.indexOf("#")+1),a={},s=o.split("&"),c=0,u=s.length;u>c;c++)r=s[c],i=r.split("="),a[i[0]]=i[1];return a.access_token?e(a):t(a)})})},invalidate:function(e){return new Ember.RSVP.Promise(function(t,n){var i,r;return i={token:e.access_token},r=""+window.ENV.api_host+"/oauth/revoke",Ember.$.ajax({url:r,type:"POST",data:i,dataType:"json",contentType:"application/x-www-form-urlencoded",error:n,success:t})})}}),Ember.Application.initializer({name:"authentication",before:"simple-auth",initialize:function(t){return t.register("twingl:authenticators:oauth2",e)}})}).call(this);
(function(){window.ENV||(window.ENV={}),window.ENV.default_page="http://google.com",window.ENV.search_page="http://google.com",window.ENV.api_host="https://app.trailblazer.io",window.ENV.api_namespace="api/v1",window.ENV.api_base=""+window.ENV.api_host+"/"+window.ENV.api_namespace,window.ENV["simple-auth"]={store:"simple-auth-session-store:ephemeral",authorizer:"simple-auth-authorizer:oauth2-bearer",crossOriginWhitelist:[window.ENV.api_host]},window.Twingl=Ember.Application.create({ready:function(){return document.title="Twingl Browser"},customEvents:{close:"webviewClose",consolemessage:"webviewConsoleMessage",contentload:"webviewContentLoad",dialog:"webviewClose",exit:"webviewExit",findupdate:"webviewFindUpdate",loadabort:"webviewLoadAbort",loadcommit:"webviewLoadCommit",loadredirect:"webviewLoadRedirect",loadstart:"webviewLoadStart",loadstop:"webviewLoadStop",newwindow:"webviewNewWindow",permissionrequest:"webviewPermissionRequest",responsive:"webviewResponsive",sizechanged:"webviewSizeChanged",unresponsive:"webviewUnresponsive",zoomchange:"webviewZoomChanged"}}),Twingl.views||(Twingl.views={})}).call(this);
(function(){Twingl.ApplicationAdapter=DS.RESTAdapter.extend({namespace:window.ENV.api_namespace,host:window.ENV.api_host})}).call(this);
(function(){Twingl.Assignment=DS.Model.extend({title:DS.attr("string"),description:DS.attr("string"),started_at:DS.attr("date"),completed_at:DS.attr("date"),current_node_id:DS.attr("number"),project_id:DS.attr("number")})}).call(this);
(function(){Twingl.ApplicationController=Ember.Controller.extend({needs:["tree","webview","navigation"],assignment:void 0,actions:{showAssignments:function(){return this.set("assignment",void 0),this.get("controllers.tree").resetState(),this.get("controllers.webview").resetState(),this.get("controllers.navigation").resetState(),this.transitionToRoute("assignments")},resetState:function(){var e,t,n,i;for(i=this.needs,t=0,n=i.length;n>t;t++)e=i[t],this.get("controllers."+e).resetState();return this.transitionToRoute("login")},minimizeWindow:function(){return chrome.app.window.current().minimize()},maximizeWindow:function(){return console.log(chrome.app.window.current().isMaximized()),chrome.app.window.current().isMaximized()?chrome.app.window.current().restore():chrome.app.window.current().maximize()},closeWindow:function(){return chrome.app.window.current().close()}}})}).call(this);
(function(){Twingl.AssignmentsController=Ember.Controller.extend({needs:["application","tree"],actions:{setAssignment:function(t){return this.get("controllers.application").set("assignment",t),this.transitionToRoute("loading"),this.get("controllers.tree").send("loadHistory",function(t){return function(){return t.transitionToRoute("browser")}}(this))}}})}).call(this);
(function(){Twingl.IndexController=Ember.Controller.extend()}).call(this);
(function(){Twingl.LoginController=Ember.Controller.extend(SimpleAuth.LoginControllerMixin,{authenticator:"twingl:authenticators:oauth2"})}).call(this);
(function(){Twingl.NavigationController=Ember.Controller.extend({needs:["webview","tree"],webview:Ember.computed.alias("controllers.webview"),tree:Ember.computed.alias("controllers.tree"),resetState:function(){return this.set("loading",!1),this.set("url",""),$("#tb-pane-alt").hide(),$("#tb-pane-main").removeClass("blur"),$(".tb-navigation-element-main").show(),$(".tb-navigation-element-alt").hide()},url:"",loading:!1,actions:{navigateUrl:function(){return this.get("webview").navigate(this.get("url"))},navigateSearch:function(){return this.get("webview").navigate(window.ENV.search_page)},navigateReload:function(){return this.get("webview").reload()},historyShow:function(){return this.set("loading",!1),$("#tb-pane-alt").show(),$("#tb-pane-main").addClass("blur"),$(".tb-navigation-element-main").hide(),$(".tb-navigation-element-alt").show(0,function(e){return function(){return e.get("tree").send("drawTree")}}(this))},browserShow:function(){return $("#tb-pane-alt").hide(),$("#tb-pane-main").removeClass("blur"),$(".tb-navigation-element-main").show(),$(".tb-navigation-element-alt").hide()}}})}).call(this);
(function(){Twingl.TreeController=Ember.Controller.extend({needs:["application","navigation","webview"],application:Ember.computed.alias("controllers.application"),navigation:Ember.computed.alias("controllers.navigation"),webview:Ember.computed.alias("controllers.webview"),assignment:Ember.computed.alias("controllers.application.assignment"),historyStack:[],historyMap:{},resetState:function(){return this.set("currentNodeId",void 0),this.set("historyStack",[]),this.set("historyMap",{}),this.set("currentViewCenter",[0,0]),this.set("currentViewScale",.2)},currentNodeId:void 0,currentNode:function(){return this.get("historyMap")[this.get("currentNodeId")]},currentViewCenter:[0,0],currentViewScale:.2,d3data:{nodes:{size:25},svg:void 0,force:d3.layout.force().size([100,100]).charge(-1600).chargeDistance(1600).linkDistance(200).linkStrength(1).friction(.8).gravity(0)},updateCurrentNode:function(t){var e,n;return this.set("currentNodeId",t.id),e=this.get("assignment").get("id"),Ember.$.ajax(""+window.ENV.api_base+"/assignments/"+e,{method:"PUT",data:{assignment:{current_node_id:t.id}}}),t.visited_at?void 0:Ember.$.ajax(n=""+window.ENV.api_base+"/nodes/"+t.id,{method:"PUT",data:{node:{arrived_at:(new Date).toISOString()}}})},generateTemporaryId:function(){return"TB.tmp."+Math.random().toString(36).substr(2,9)},actions:{loadHistory:function(t){var e,n;return e=this.get("assignment").get("id"),n=""+window.ENV.api_base+"/assignments/"+e+"/nodes",Ember.$.get(n,function(e){return function(n){var r,i,o,s,a;if(n.nodes.length>0){for(a=n.nodes,o=0,s=a.length;s>o;o++)i=a[o],e.get("historyStack").push(i),e.get("historyMap")[i.id]=i;r=e.get("assignment").get("current_node_id"),r&&e.get("historyMap").hasOwnProperty(r)?e.set("currentNodeId",e.get("assignment").get("current_node_id")):e.set("currentNodeId",e.get("historyStack").filterBy("arrived_at")[0].id),setTimeout(function(){return e.get("navigation").send("historyShow")},40),e.get("webview").navigate(e.currentNode().url,!1)}else e.get("webview").navigate(window.ENV.default_page);return console.log(e.get("historyStack"),e.get("historyMap")),t()}}(this))},pushItem:function(t){var e,n,r;return e=this.get("assignment").get("id"),r=""+window.ENV.api_base+"/assignments/"+e+"/nodes",n=this.generateTemporaryId(),t=Ember.$.extend(t,{id:n,parent_id:this.get("currentNodeId"),arrived_at:(new Date).toISOString(),idle:!1}),Ember.$.post(r,{node:t},function(e){return function(r){return t.id=r.id,e.get("historyMap")[t.id]=t,delete e.get("historyMap")[n],e.updateCurrentNode(t)}}(this)),this.get("historyStack").push(t),this.get("historyMap")[t.id]=t,this.get("historyMap")[t.id].x=this.get("historyMap")[this.get("currentNodeId")].x,this.get("historyMap")[t.id].y=this.get("historyMap")[this.get("currentNodeId")].y,console.log(this.get("historyStack"),this.get("historyMap"))},queueUnread:function(t){var e,n,r;return e=this.get("assignment").get("id"),r=""+window.ENV.api_base+"/assignments/"+e+"/nodes",n=this.generateTemporaryId(),t=Ember.$.extend(t,{id:n,parent_id:this.get("currentNodeId"),idle:!1}),Ember.$.post(r,{node:t},function(e){return function(r){var i;return t.id=r.id,e.get("historyMap")[t.id]=t,delete e.get("historyMap")[n],t.title?void 0:(i=document.createElement("webview"),i.src=t.url,i.addEventListener("contentload",function(n){return console.log("contentload",n),i.executeScript({code:"document.title"},function(n){return document.body.removeChild(i),e.get("historyMap")[t.id].title=n[0],Ember.$.ajax(""+window.ENV.api_base+"/nodes/"+t.id,{method:"PUT",data:{node:{title:n[0]}}})})}),document.body.appendChild(i))}}(this)),this.get("historyStack").push(t),this.get("historyMap")[t.id]=t},drawTree:function(){return Ember.$("#tb-history-tree-viz").html(""),this.get("d3data").svg=d3.select("#tb-history-tree-viz").append("svg"),this.get("historyStack").length>0?this.update():void 0}},update:function(){var t,e,n,r,i,o,s,a,d,u,c,g,h,l,p,f;u=this.get("historyMap"),n=$.extend(!0,{},u),console.log(n),d=[],g=[],i={},o=0;for(r in n)c=n[r],i[c.id]=o++,c.x||(c.x=50),c.y||(c.y=50),c.offsets={x:2*this.get("d3data").nodes.size,y:{minor:1.1*this.get("d3data").nodes.size,major:2.3*this.get("d3data").nodes.size}},c.parent_id?d.push({source:i[c.parent_id],target:i[c.id]}):(c.x=50,c.y=50,c.fixed=!0),g.push(c);return e=this.get("d3data").force,p=this.get("d3data").svg,t=p.append("g"),f=d3.behavior.zoom().scaleExtent([.2,2]).on("zoom",function(e){return function(){return e.set("currentViewCenter",[window.innerWidth/2-d3.event.translate[0],window.innerHeight/2-d3.event.translate[1]-64]),e.set("currentViewScale",d3.event.scale),t.transition().duration(100).ease(d3.ease("cubic-out")).attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}}(this)),p.call(f),e.nodes(g).links(d).start(),a=t.selectAll(".link").data(d).enter().append("line").attr("class","link"),c=t.selectAll("g.node").data(g,function(t){return t.id}).enter().append("g").attr("class",function(t){return function(e){return"node "+(""+(e.arrived_at?void 0:"unread")+" ")+(""+(e.id===t.get("currentNodeId")?"current":void 0)+" ")}}(this)),h=function(e){return function(n){return null==n&&(n=300),f.translate([window.innerWidth/2-e.get("currentViewCenter")[0],window.innerHeight/2-e.get("currentViewCenter")[1]-64]),f.scale(e.get("currentViewScale")),t.transition().duration(n).ease(d3.ease("cubic-out")).attr("transform","translate("+[window.innerWidth/2-e.get("currentViewCenter")[0],window.innerHeight/2-e.get("currentViewCenter")[1]-64]+")scale("+e.get("currentViewScale")+")")}}(this),h(0),window.onresize=_.debounce(function(){return function(){return h(0)}}(this),20),c.on("click",function(t){return function(e){return t.updateCurrentNode(e),t.get("webview").navigate(e.url,!1)}}(this)),l=c.append("polygon").attr("stroke-linejoin","round"),s=c.append("foreignObject").attr("requiredFeatures","http://www.w3.org/TR/SVG11/feature#Extensibility").attr("x",0).attr("y",0).attr("width",4*this.get("d3data").nodes.size).attr("height",2.2*this.get("d3data").nodes.size),s.append("xhtml:body").append("p").text(function(t){return t.title}),e.on("tick",function(){return function(){return a.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),l.attr("points",function(t){return""+(t.x+t.offsets.x)+","+(t.y+t.offsets.y.minor)+" "+(""+(t.x+t.offsets.x)+","+(t.y-t.offsets.y.minor)+" ")+(""+t.x+","+(t.y-t.offsets.y.major)+" ")+(""+(t.x-t.offsets.x)+","+(t.y-t.offsets.y.minor)+" ")+(""+(t.x-t.offsets.x)+","+(t.y+t.offsets.y.minor)+" ")+(""+t.x+","+(t.y+t.offsets.y.major)+" ")}),s.attr("x",function(t){return t.x-t.offsets.x}).attr("y",function(t){return t.y-t.offsets.y.minor})}}(this)),e.on("end",function(t){return function(){var e;return e={},_.each(g,function(n){return t.get("historyMap")[n.id].x=n.x,t.get("historyMap")[n.id].y=n.y,e[n.id]={x:n.x,y:n.y}}),Ember.$.ajax(""+window.ENV.api_base+"/assignments/"+t.get("assignment").id+"/nodes/coords",{method:"PUT",contentType:"application/json",data:JSON.stringify({nodes:e})})}}(this))}})}).call(this);
(function(){Twingl.WebviewController=Ember.Controller.extend({needs:["navigation","tree"],navigation:Ember.computed.alias("controllers.navigation"),tree:Ember.computed.alias("controllers.tree"),currentNode:Ember.computed.alias("controllers.tree.currentNode"),resetState:function(){return this.set("url",""),this.set("state",void 0)},state:void 0,states:{"default":0,nav_tree:1,nav_browser:2},updateTree:function(t){switch(this.state){case this.states.nav_tree:return console.log("nav_tree"),this.state=this.states["default"];case this.states.nav_browser:return console.log("nav_browser"),this.state=this.states["default"];default:return console.log("nav_default"),this.get("tree").send("pushItem",{url:t.url,title:t.title}),this.state=this.states["default"]}},url:"",navigate:function(t,e){return null==e&&(e=!0),e||this.set("state",this.states.nav_tree),this.set("url",t),Ember.$("#tb-pane-main webview").attr("src",t)},navigateForward:function(){return $("#tb-pane-main webview")[0].forward()},navigateBack:function(){return $("#tb-pane-main webview")[0].back()},reload:function(){return $("#tb-pane-main webview")[0].reload()},actions:{loadStart:function(){return this.get("navigation").set("loading",!0)},loadStop:function(){return this.get("navigation").set("loading",!1)},loadCommit:function(t){return t.originalEvent.isTopLevel&&this.get("currentNode").url!==t.originalEvent.url?Ember.$("#tb-pane-main webview")[0].executeScript({code:"document.title"},function(e){return function(n){return t.originalEvent.title=n[0],e.updateTree(t.originalEvent),e.get("navigation").set("url",t.originalEvent.url)}}(this)):void 0},loadRedirect:function(t){return t.originalEvent.isTopLevel?this.get("navigation").set("url",t.originalEvent.url):void 0},newWindow:function(t){return this.get("tree").send("queueUnread",{url:t.originalEvent.targetUrl})}}})}).call(this);
(function(){Twingl.AssignmentListItem=Ember.Component.extend({tagName:"li",classNames:[],action:"setAssignment",layoutName:"main/assignments/list_item",click:function(){return this.sendAction("action",this.assignment)}})}).call(this);
(function(){Twingl.AssignmentSwitcher=Ember.Component.extend({tagName:"button",classNames:["tb-assignment-switch","tb-window-nav"],action:"showAssignments",layoutName:"windowNavigation/assignment_switcher",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.BrowserShowButton=Ember.Component.extend({tagName:"i",classNames:["tb-browser-show","tb-nav-button","fa","fa-arrow-left"],action:"browserShow",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.HistoryReloadButton=Ember.Component.extend({tagName:"button",classNames:["tb-history-reload","tb-nav-button"],action:"navigateReload",layoutName:"button",text:"Reload",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.HistoryShowButton=Ember.Component.extend({tagName:"i",classNames:["tb-history-show","tb-nav-button","fa","fa-share-alt"],action:"historyShow",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.LogoutButton=Ember.Component.extend({tagName:"i",classNames:["tb-auth-logout","tb-nav-button","fa","fa-sign-out"],action:"invalidateSession",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.SearchButton=Ember.Component.extend({tagName:"i",classNames:["tb-search-show","tb-nav-button","fa","fa-search"],action:"navigateSearch",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.UrlSubmitButton=Ember.Component.extend({tagName:"button",classNames:["tb-url-submit","tb-nav-button"],action:"navigateUrl",layoutName:"button",text:"Go",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.UrlTextField=Ember.TextField.extend({classNames:["tb-url-input"],placeholder:"http://example.com",action:"navigateUrl",attributeBindings:["value"],insertNewline:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.Webview=Ember.View.extend({tagName:"webview",attributeBindings:["src"],webviewLoadCommit:function(e){return this.get("controller").send("loadCommit",e)},webviewLoadRedirect:function(e){return this.get("controller").send("loadRedirect",e)},webviewLoadStart:function(e){return this.get("controller").send("loadStart",e)},webviewLoadStop:function(e){return this.get("controller").send("loadStop",e)},webviewNewWindow:function(e){return this.get("controller").send("newWindow",e)}})}).call(this);
(function(){Twingl.WindowCloseButton=Ember.Component.extend({tagName:"i",classNames:["tb-window-close","tb-window-control","fa","fa-times"],action:"closeWindow",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.WindowMaximizeButton=Ember.Component.extend({tagName:"i",classNames:["tb-window-maximize","tb-window-control","fa","fa-plus"],action:"maximizeWindow",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.WindowMinimizeButton=Ember.Component.extend({tagName:"i",classNames:["tb-window-minimize","tb-window-control","fa","fa-minus"],action:"minimizeWindow",click:function(){return this.sendAction()}})}).call(this);
(function(){Twingl.ApplicationRoute=Ember.Route.extend(SimpleAuth.ApplicationRouteMixin,{actions:{sessionAuthenticationSucceeded:function(){return console.log("logged in"),this.transitionTo("assignments")},sessionAuthenticationFailed:function(o){return console.log("failed to log in",o)},authorizationFailed:function(o){return console.log("failed to authorize",o)},sessionInvalidationSucceeded:function(){return console.log("logged out"),this.get("controller").send("resetState")},sessionInvalidationFailed:function(o){return console.log("failed to log out",o)}}})}).call(this);
(function(){Twingl.AssignmentsRoute=Ember.Route.extend(SimpleAuth.AuthenticatedRouteMixin,{model:function(){return this.store.findAll("assignment")},renderTemplate:function(){return this.render("main/assignments/index",{outlet:"main",controller:"assignments"}),this.render("navigation/assignments",{outlet:"navigation",controller:"navigation"})}})}).call(this);
(function(){Twingl.BrowserRoute=Ember.Route.extend(SimpleAuth.AuthenticatedRouteMixin,{renderTemplate:function(){return this.render("main/webview",{outlet:"main",controller:"webview"}),this.render("navigation/browser",{outlet:"navigation",controller:"navigation"}),this.render("alt/tree",{outlet:"alt",controller:"tree"}),this.render("windowNavigation/projects",{outlet:"windowNavigation",controller:"application"})}})}).call(this);
(function(){Twingl.IndexRoute=Ember.Route.extend({beforeModel:function(){return this.transitionTo("login")}})}).call(this);
(function(){Twingl.LoadingRoute=Ember.Route.extend({renderTemplate:function(){return this.render("main/loading",{outlet:"main"})}})}).call(this);
(function(){Twingl.LoginRoute=Ember.Route.extend({renderTemplate:function(){return this.render("main/auth/login",{outlet:"main",controller:"login"})}})}).call(this);
(function(){Twingl.Router.map(function(){return this.route("assignments"),this.route("browser"),this.route("loading"),this.route("login")})}).call(this);