(function() {
  var OAuth2Authenticator;

  OAuth2Authenticator = SimpleAuth.Authenticators.Base.extend({
    restore: function(properties) {},
    authenticate: function(credentials) {
      return new Ember.RSVP.Promise(function(resolve, reject) {
        var authUrl, clientId, redirect, url;
        authUrl = "http://localhost:3000/oauth/authorize";
        redirect = encodeURIComponent("https://" + chrome.runtime.id + ".chromiumapp.org/");
        clientId = "3e28871e11e0f4bf55e464bc20cd1774eb8da855a470b5eda766fed6f78943f3";
        url = "" + authUrl + "?client_id=" + clientId + "&response_type=token&redirect_uri=" + redirect;
        return chrome.identity.launchWebAuthFlow({
          'url': url,
          'interactive': true
        }, function(redirectUrl) {
          var accessToken, i, item, o, _i, _len, _ref;
          accessToken = redirectUrl.substring(redirectUrl.indexOf("#") + 1);
          o = {};
          _ref = accessToken.split('&');
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            item = _ref[_i];
            i = item.split('=');
            o[i[0]] = i[1];
          }
          return resolve(o);
        });
      });
    },
    invalidate: function(data) {
      return new Ember.RSVP.Promise(function(resolve, reject) {
        var body, url;
        body = {
          token: data['access_token']
        };
        url = "http://localhost:3000/oauth/revoke";
        return Ember.$.ajax({
          url: url,
          type: 'POST',
          data: body,
          dataType: 'json',
          contentType: 'application/x-www-form-urlencoded',
          error: reject,
          success: resolve
        });
      });
    }
  });

  Ember.Application.initializer({
    name: 'authentication',
    before: 'simple-auth',
    initialize: function(container, application) {
      return container.register('twingl:authenticators:oauth2', OAuth2Authenticator);
    }
  });

}).call(this);


/*
 * Configure SimpleAuth
 */

(function() {
  window.ENV || (window.ENV = {});

  window.ENV['default_page'] = "http://google.com";

  window.ENV['search_page'] = "http://google.com";

  window.ENV['api_host'] = "http://localhost:3000";

  window.ENV['api_namespace'] = "api/v1";

  window.ENV['api_base'] = "" + window.ENV['api_host'] + "/" + window.ENV['api_namespace'];

  window.ENV['simple-auth'] = {
    store: 'simple-auth-session-store:ephemeral',
    authorizer: 'simple-auth-authorizer:oauth2-bearer',
    crossOriginWhitelist: [window.ENV['api_host']]
  };

  window.Twingl = Ember.Application.create({
    rootElement: "#app",
    ready: function() {
      return document.title = "Twingl Browser";
    },
    customEvents: {
      close: "webviewClose",
      consolemessage: "webviewConsoleMessage",
      contentload: "webviewContentLoad",
      dialog: "webviewClose",
      exit: "webviewExit",
      findupdate: "webviewFindUpdate",
      loadabort: "webviewLoadAbort",
      loadcommit: "webviewLoadCommit",
      loadredirect: "webviewLoadRedirect",
      loadstart: "webviewLoadStart",
      loadstop: "webviewLoadStop",
      newwindow: "webviewNewWindow",
      permissionrequest: "webviewPermissionRequest",
      responsive: "webviewResponsive",
      sizechanged: "webviewSizeChanged",
      unresponsive: "webviewUnresponsive",
      zoomchange: "webviewZoomChanged"
    }
  });

  Twingl.views || (Twingl.views = {});

}).call(this);

(function() {
  Twingl.ApplicationAdapter = DS.RESTAdapter.extend({
    namespace: window.ENV['api_namespace'],
    host: window.ENV['api_host']
  });

}).call(this);

(function() {
  Twingl.Assignment = DS.Model.extend({
    name: DS.attr('string'),
    started_at: DS.attr('date'),
    completed_at: DS.attr('date')
  });

}).call(this);

(function() {
  Twingl.ApplicationController = Ember.Controller.extend({
    needs: ['tree', 'webview', 'navigation'],
    assignment: void 0,
    actions: {
      showAssignments: function() {
        this.set('assignment', void 0);
        this.get("controllers.tree").resetState();
        this.get("controllers.webview").resetState();
        this.get("controllers.navigation").resetState();
        return this.transitionToRoute('assignments');
      },
      resetState: function() {
        var c, _i, _len, _ref;
        _ref = this.needs;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          this.get("controllers." + c).resetState();
        }
        return this.transitionToRoute('login');
      },
      minimizeWindow: function() {
        return chrome.app.window.current().minimize();
      },
      maximizeWindow: function() {
        console.log(chrome.app.window.current().isMaximized());
        if (chrome.app.window.current().isMaximized()) {
          return chrome.app.window.current().restore();
        } else {
          return chrome.app.window.current().maximize();
        }
      },
      closeWindow: function() {
        return chrome.app.window.current().close();
      }
    }
  });

}).call(this);

(function() {
  Twingl.AssignmentsController = Ember.Controller.extend({
    needs: ['application', 'tree'],
    actions: {
      setAssignment: function(assignment) {
        this.get("controllers.application").set("assignment", assignment);
        this.transitionToRoute('loading');
        return this.get("controllers.tree").send('loadHistory', (function(_this) {
          return function() {
            return _this.transitionToRoute('browser');
          };
        })(this));
      }
    }
  });

}).call(this);

(function() {
  Twingl.IndexController = Ember.Controller.extend();

}).call(this);

(function() {
  Twingl.LoginController = Ember.Controller.extend(SimpleAuth.LoginControllerMixin, {
    authenticator: 'twingl:authenticators:oauth2'
  });

}).call(this);

(function() {
  Twingl.NavigationController = Ember.Controller.extend({
    needs: ['webview', 'tree'],
    webview: Ember.computed.alias("controllers.webview"),
    tree: Ember.computed.alias("controllers.tree"),
    resetState: function() {
      this.set('loading', false);
      this.set('url', '');
      $('#tb-pane-alt').hide();
      $('.tb-navigation-element-main').show();
      return $('.tb-navigation-element-alt').hide();
    },
    url: '',
    loading: false,
    actions: {

      /*
       * User instigated events - UI elements
       */
      navigateUrl: function() {
        return this.get('webview').navigate(this.get('url'));
      },
      navigateSearch: function() {
        return this.get('webview').navigate(window.ENV['search_page']);
      },
      navigateReload: function() {
        return this.get('webview').reload();
      },
      historyShow: function() {
        this.set('loading', false);
        $('#tb-pane-alt').show();
        $('.tb-navigation-element-main').hide();
        return $('.tb-navigation-element-alt').show(0, (function(_this) {
          return function() {
            return _this.get('tree').send('drawTree');
          };
        })(this));
      },
      browserShow: function() {
        $('#tb-pane-alt').hide();
        $('.tb-navigation-element-main').show();
        return $('.tb-navigation-element-alt').hide();
      }
    }
  });

}).call(this);

(function() {
  Twingl.TreeController = Ember.Controller.extend({
    needs: ['application', 'navigation', 'webview'],
    application: Ember.computed.alias("controllers.application"),
    navigation: Ember.computed.alias("controllers.navigation"),
    webview: Ember.computed.alias("controllers.webview"),
    assignment: Ember.computed.alias("controllers.application.assignment"),
    historyStack: [],
    historyMap: {},
    resetState: function() {
      this.set("currentNodeId", void 0);
      this.set("historyStack", []);
      return this.set("historyMap", {});
    },
    currentNodeId: void 0,
    currentNode: function() {
      return this.get("historyMap")[this.get("currentNodeId")];
    },

    /*
     * A sample node structure
     *
     * {
     *   id: ID, (assigned a temporary ID before the persisted ID is known)
     *   url: String,
     *   title: String,
     *   arrived_at: Date,
     *   departed_at: Date,
     *   idle: Boolean
     * }
     *
     */
    generateTemporaryId: function() {
      return "TB.tmp." + Math.random().toString(36).substr(2, 9);
    },
    actions: {
      loadHistory: function(cb) {
        var id, url;
        id = this.get('assignment').get('id');
        url = "" + window.ENV['api_base'] + "/assignments/" + id + "/nodes";
        return Ember.$.get(url, (function(_this) {
          return function(response) {
            var currentNodeId, node, _i, _len, _ref;
            if (response.nodes.length > 0) {
              _ref = response.nodes;
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                node = _ref[_i];
                _this.get('historyStack').push(node);
                _this.get('historyMap')[node.id] = node;
              }
              currentNodeId = _this.get('assignment').get('current_node_id');
              if (currentNodeId && _this.get('historyMap').hasOwnProperty(currentNodeId)) {
                _this.set('currentNodeId', _this.get('assignment').get('current_node_id'));
              } else {
                _this.set('currentNodeId', _this.get('historyStack').filterBy("arrived_at")[0].id);
              }
              _this.get('navigation').send('historyShow');
              _this.get('webview').navigate(_this.currentNode().url, false);
            } else {
              _this.get('webview').navigate(window.ENV['default_page']);
            }
            console.log(_this.get('historyStack'), _this.get('historyMap'));
            return cb();
          };
        })(this));
      },
      pushItem: function(node) {
        var id, temporaryId, url;
        id = this.get('assignment').get('id');
        url = "" + window.ENV['api_base'] + "/assignments/" + id + "/nodes";
        temporaryId = this.generateTemporaryId();
        node = Ember.$.extend(node, {
          id: temporaryId,
          arrived_at: (new Date()).toISOString(),
          idle: false
        });
        Ember.$.post(url, {
          node: node
        }, (function(_this) {
          return function(response) {
            node.id = response.id;
            _this.get("historyMap")[node.id] = node;
            return delete _this.get("historyMap")[temporaryId];
          };
        })(this));
        this.get("historyStack").push(node);
        this.get("historyMap")[node.id] = node;
        return console.log(this.get('historyStack'), this.get('historyMap'));
      },
      queueUnread: function(node) {
        var id, temporaryId, url;
        id = this.get('assignment').get('id');
        url = "" + window.ENV['api_base'] + "/assignments/" + id + "/nodes";
        temporaryId = this.generateTemporaryId();
        node = Ember.$.extend(node, {
          id: temporaryId,
          idle: false
        });
        Ember.$.post(url, {
          node: node
        }, (function(_this) {
          return function(response) {
            node.id = response.id;
            _this.get("historyMap")[node.id] = node;
            return delete _this.get("historyMap")[temporaryId];
          };
        })(this));
        this.get("historyStack").push(node);
        this.get("historyMap")[node.id] = node;
        return console.log(this.get('historyStack'), this.get('historyMap'));
      }
    }
  });

}).call(this);

(function() {
  Twingl.WebviewController = Ember.Controller.extend({

    /*
     * This Controller is responsible for actioning navigation events and catching
     * the events emitted by the <webview>, filtering, and bubbling on appropriate
     * events to NavigationController so that it can manage the state effectively.
     */
    needs: ['navigation', 'tree'],
    navigation: Ember.computed.alias("controllers.navigation"),
    tree: Ember.computed.alias("controllers.tree"),
    currentNode: Ember.computed.alias("controllers.tree.currentNode"),
    resetState: function() {
      this.set('url', '');
      return this.set('state', void 0);
    },
    state: void 0,
    states: {
      "default": 0,
      nav_tree: 1,
      nav_browser: 2
    },
    updateTree: function(node) {
      switch (this.state) {
        case this.states.nav_tree:
          console.log("nav_tree");
          return this.state = this.states["default"];
        case this.states.nav_browser:
          console.log("nav_browser");
          return this.state = this.states["default"];
        default:
          console.log("nav_default");
          this.get('tree').send('pushItem', {
            url: node.url,
            title: node.title
          });
          return this.state = this.states["default"];
      }
    },
    url: '',
    navigate: function(url, triggerNewNode) {
      if (triggerNewNode == null) {
        triggerNewNode = true;
      }
      if (!triggerNewNode) {
        this.set('state', this.states.nav_tree);
      }
      this.set('url', url);
      return Ember.$('webview').attr('src', url);
    },
    navigateForward: function() {
      return $('webview')[0].forward();
    },
    navigateBack: function() {
      return $('webview')[0].back();
    },
    reload: function() {
      return $('webview')[0].reload();
    },
    actions: {
      loadStart: function(e) {
        return this.get('navigation').set('loading', true);
      },
      loadStop: function(e) {
        return this.get('navigation').set('loading', false);
      },
      loadCommit: function(e) {
        if (e.originalEvent.isTopLevel && this.get('currentNode').url !== e.originalEvent.url) {
          return Ember.$('webview')[0].executeScript({
            code: "document.title"
          }, (function(_this) {
            return function(r) {
              e.originalEvent.title = r[0];
              _this.updateTree(e.originalEvent);
              return _this.get('navigation').set('url', e.originalEvent.url);
            };
          })(this));
        }
      },
      loadRedirect: function(e) {
        if (e.originalEvent.isTopLevel) {
          return this.get('navigation').set('url', e.originalEvent.url);
        }
      },
      newWindow: function(e) {
        return this.get('tree').send('queueUnread', {
          url: e.originalEvent.targetUrl
        });
      }
    }
  });

}).call(this);

(function() {
  Twingl.AssignmentListItem = Ember.Component.extend({
    tagName: 'li',
    classNames: [],
    action: "setAssignment",
    layoutName: "main/assignments/list_item",
    click: function() {
      return this.sendAction('action', this.assignment);
    }
  });

}).call(this);

(function() {
  Twingl.AssignmentSwitcher = Ember.Component.extend({
    tagName: "button",
    classNames: ["tb-assignment-switch", "tb-window-nav"],
    action: "showAssignments",
    layoutName: "windowNavigation/assignment_switcher",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.BrowserShowButton = Ember.Component.extend({
    tagName: "i",
    classNames: ["tb-browser-show", "tb-nav-button", "fa", "fa-arrow-left"],
    action: "browserShow",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.HistoryReloadButton = Ember.Component.extend({
    tagName: 'button',
    classNames: ['tb-history-reload', 'tb-nav-button'],
    action: "navigateReload",
    layoutName: "button",
    text: "Reload",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.HistoryShowButton = Ember.Component.extend({
    tagName: "i",
    classNames: ["tb-history-show", "tb-nav-button", "fa", "fa-share-alt"],
    action: "historyShow",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.LogoutButton = Ember.Component.extend({
    tagName: "i",
    classNames: ["tb-auth-logout", "tb-nav-button", "fa", "fa-sign-out"],
    action: "invalidateSession",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.SearchButton = Ember.Component.extend({
    tagName: "i",
    classNames: ["tb-search-show", "tb-nav-button", "fa", "fa-search"],
    action: "navigateSearch",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.UrlSubmitButton = Ember.Component.extend({
    tagName: 'button',
    classNames: ['tb-url-submit', 'tb-nav-button'],
    action: "navigateUrl",
    layoutName: "button",
    text: "Go",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.UrlTextField = Ember.TextField.extend({
    classNames: ['tb-url-input'],
    placeholder: 'http://example.com',
    action: "navigateUrl",
    attributeBindings: ['value'],
    insertNewline: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.Webview = Ember.View.extend({
    tagName: 'webview',
    attributeBindings: ['src'],
    webviewLoadCommit: function(evt) {
      return this.get('controller').send('loadCommit', evt);
    },
    webviewLoadRedirect: function(evt) {
      return this.get('controller').send('loadRedirect', evt);
    },
    webviewLoadStart: function(evt) {
      return this.get('controller').send('loadStart', evt);
    },
    webviewLoadStop: function(evt) {
      return this.get('controller').send('loadStop', evt);
    },
    webviewNewWindow: function(evt) {
      return this.get('controller').send('newWindow', evt);
    }
  });

}).call(this);

(function() {
  Twingl.WindowCloseButton = Ember.Component.extend({
    tagName: "i",
    classNames: ["tb-window-close", "tb-window-control", "fa", "fa-times"],
    action: "closeWindow",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.WindowMaximizeButton = Ember.Component.extend({
    tagName: "i",
    classNames: ["tb-window-maximize", "tb-window-control", "fa", "fa-plus"],
    action: "maximizeWindow",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.WindowMinimizeButton = Ember.Component.extend({
    tagName: "i",
    classNames: ["tb-window-minimize", "tb-window-control", "fa", "fa-minus"],
    action: "minimizeWindow",
    click: function() {
      return this.sendAction();
    }
  });

}).call(this);

(function() {
  Twingl.ApplicationRoute = Ember.Route.extend(SimpleAuth.ApplicationRouteMixin, {
    actions: {
      sessionAuthenticationSucceeded: function() {
        console.log("logged in");
        return this.transitionTo('assignments');
      },
      sessionAuthenticationFailed: function(error) {
        return console.log("failed to log in", error);
      },
      authorizationFailed: function(error) {
        return console.log("failed to authorize", error);
      },
      sessionInvalidationSucceeded: function() {
        console.log("logged out");
        return this.get('controller').send('resetState');
      },
      sessionInvalidationFailed: function(error) {
        return console.log("failed to log out", error);
      }
    }
  });

}).call(this);

(function() {
  Twingl.AssignmentsRoute = Ember.Route.extend(SimpleAuth.AuthenticatedRouteMixin, {
    model: function() {
      return this.store.findAll('assignment');
    },
    renderTemplate: function() {
      this.render('main/assignments/index', {
        outlet: 'main',
        controller: 'assignments'
      });
      return this.render('navigation/assignments', {
        outlet: 'navigation',
        controller: 'navigation'
      });
    }
  });

}).call(this);

(function() {
  Twingl.BrowserRoute = Ember.Route.extend(SimpleAuth.AuthenticatedRouteMixin, {
    renderTemplate: function() {
      this.render('main/webview', {
        outlet: 'main',
        controller: 'webview'
      });
      this.render('navigation/browser', {
        outlet: 'navigation',
        controller: 'navigation'
      });
      this.render('alt/tree', {
        outlet: 'alt',
        controller: 'tree'
      });
      return this.render('windowNavigation/projects', {
        outlet: 'windowNavigation',
        controller: 'application'
      });
    }
  });

}).call(this);

(function() {
  Twingl.IndexRoute = Ember.Route.extend({
    beforeModel: function() {
      return this.transitionTo('login');
    }
  });

}).call(this);

(function() {
  Twingl.LoadingRoute = Ember.Route.extend({
    renderTemplate: function() {
      return this.render('main/loading', {
        outlet: 'main'
      });
    }
  });

}).call(this);

(function() {
  Twingl.LoginRoute = Ember.Route.extend({
    renderTemplate: function() {
      return this.render('main/auth/login', {
        outlet: 'main',
        controller: 'login'
      });
    }
  });

}).call(this);

(function() {
  Twingl.Router.map(function() {
    this.route('assignments');
    this.route('browser');
    this.route('loading');
    return this.route('login');
  });

}).call(this);

(function() {


}).call(this);
